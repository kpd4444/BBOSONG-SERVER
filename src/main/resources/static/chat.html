<!doctype html>
<html lang="ko">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>ë½€ì†¡ì´ ì±—ë´‡ í…ŒìŠ¤íŠ¸</title>
    <style>
        :root{--blue:#3B82F6;--line:#e5e7eb;}
        body{margin:0;background:#eef2ff;font-family:system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Malgun Gothic,sans-serif}
        .wrap{max-width:420px;margin:0 auto;padding:16px}
        .card{background:#fff;border-radius:18px;box-shadow:0 8px 24px rgba(0,0,0,.08);overflow:hidden}
        header{padding:12px 16px;border-bottom:1px solid var(--line);font-weight:700}
        .msgs{height:68vh;overflow:auto;padding:12px;background:linear-gradient(#eef2ff 40%,#ffffff)}
        .row{display:flex;margin:8px 12px}
        .bubble{padding:10px 12px;border-radius:14px;max-width:80%;white-space:pre-wrap}
        .user{justify-content:flex-end}
        .user .bubble{background:var(--blue);color:#fff;border-bottom-right-radius:6px}
        .bot .bubble{background:#F3F4F6;color:#111;border-bottom-left-radius:6px}
        .thumb{max-width:170px;border-radius:10px;display:block;margin-top:6px;border:1px solid var(--line)}
        .small{font-size:12px;color:#6b7280;margin:10px 12px 0}
        .err{color:#ef4444;font-size:12px;margin:6px 12px}
        .input{display:grid;grid-template-columns:1fr auto auto;gap:8px;padding:10px;border-top:1px solid var(--line)}
        .filebox input[type="file"]{display:none}
        .filebox label{padding:10px 12px;border:1px solid var(--line);border-radius:12px;background:#fff;cursor:pointer;font-size:13px;white-space:nowrap}
        #text{padding:10px;border-radius:12px;border:1px solid var(--line)}
        #send{padding:10px 14px;border:0;border-radius:12px;background:var(--blue);color:#fff;font-weight:700;white-space:nowrap}
        #send[disabled]{opacity:.7;cursor:not-allowed}
    </style>
</head>
<body>
<div class="wrap">
    <div class="card">
        <header>ë½€ì†¡ì´</header>
        <div id="msgs" class="msgs"></div>
        <div class="small">ì‚¬ì§„ì„ ì²¨ë¶€í•´ì„œ â€œì¼€ì²©ì´ ë¬»ì—ˆì–´ìš”, ì–´ë–»ê²Œ í•˜ì£ ?â€ ê°™ì´ ë¬¼ì–´ë³´ì„¸ìš”.</div>
        <div class="err" id="err"></div>

        <div class="input">
            <input id="text" type="text" placeholder="ë©”ì‹œì§€ ì…ë ¥" />
            <div class="filebox">
                <input id="file" type="file" accept="image/*" />
                <label for="file">íŒŒì¼ ì„ íƒ</label>
            </div>
            <button id="send">ë³´ë‚´ê¸°</button>
        </div>
    </div>
</div>

<script>
    const msgs = document.getElementById('msgs');
    const text = document.getElementById('text');
    const file = document.getElementById('file');
    const send = document.getElementById('send');
    const err = document.getElementById('err');
    let conversationId = null;

    // ğŸ”¥ ë¡œê·¸ì¸ í† í° ê²€ì‚¬
    const token = localStorage.getItem("posong_jwt");
    if (!token) {
        alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
        window.location.href = "/login.html";
    }

    function append(role, content, imgUrl){
        const row = document.createElement('div');
        row.className = 'row ' + (role === 'user' ? 'user' : 'bot');
        const b = document.createElement('div');
        b.className = 'bubble';
        b.textContent = content || '';
        row.appendChild(b);
        if (imgUrl){
            const img = document.createElement('img');
            img.src = imgUrl; img.className = 'thumb';
            row.appendChild(img);
        }
        msgs.appendChild(row);
        msgs.scrollTop = msgs.scrollHeight;
    }

    async function ensureStarted(){
        if (conversationId) return;

        const res = await fetch('/api/chat/start', {
            method:'POST',
            headers: {
                "Authorization": `Bearer ${token}`
            }
        });

        if(!res.ok) throw new Error('start HTTP '+res.status);
        const json = await res.json();
        conversationId = json.conversationId;
    }

    async function sendMsg(){
        err.textContent = '';
        await ensureStarted();

        const t = text.value.trim();
        const f = file.files[0];
        if (!t && !f){ err.textContent = 'ë©”ì‹œì§€ë‚˜ ì´ë¯¸ì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”.'; return; }

        let imgPreview;
        if (f){ imgPreview = URL.createObjectURL(f); }
        append('user', t || (f ? '(ì´ë¯¸ì§€ ì „ì†¡)' : ''), imgPreview);

        const fd = new FormData();
        fd.append('conversationId', conversationId);
        if (t) fd.append('text', t);
        if (f) fd.append('file', f);

        text.value = ''; file.value = '';

        const thinking = document.createElement('div');
        thinking.className = 'row bot';
        const b = document.createElement('div');
        b.className = 'bubble';
        b.textContent = 'ìƒê°ì¤‘â€¦';
        thinking.appendChild(b);
        msgs.appendChild(thinking);

        msgs.scrollTop = msgs.scrollHeight;
        send.disabled = true;

        try{
            const res = await fetch('/api/chat/send', {
                method:'POST',
                headers: { "Authorization": `Bearer ${token}` },
                body: fd
            });

            if (!res.ok) throw new Error('send HTTP '+res.status);

            const json = await res.json();
            if (thinking.isConnected) msgs.removeChild(thinking);
            append('bot', json.assistantMessage);
        }catch(e){
            if (thinking.isConnected) msgs.removeChild(thinking);
            append('bot', 'ì „ì†¡ ì‹¤íŒ¨. ì„œë²„ ì‹¤í–‰/CORS í™•ì¸');
            err.textContent = e.message ?? 'ì „ì†¡ ì‹¤íŒ¨';
            console.error(e);
        } finally {
            send.disabled = false;
        }
    }

    send.addEventListener('click', sendMsg);
    text.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMsg(); }
    });
</script>
</body>
</html>
