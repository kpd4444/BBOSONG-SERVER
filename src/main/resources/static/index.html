<!doctype html>
<html lang="ko">
<head>
    <meta charset="utf-8" />
    <title>ë½€ì†¡ì´ â€” ë¶„ì„ ê²°ê³¼ í…ŒìŠ¤íŠ¸</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <style>
        :root{
            --primary:#3B82F6;
            --text:#111827;
            --muted:#6B7280;
            --line:#E5E7EB;
            --chip:#EEF2FF;
            --bg:#F8FAFC;
            --card:#FFFFFF;
            --radius:18px;
        }
        html,body{
            margin:0;padding:0;background:var(--bg);
            font-family:system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Malgun Gothic,sans-serif;
            color:var(--text);
        }
        .phone {
            width: 390px; margin: 24px auto; background: #0000; position: relative;
        }
        .card {
            background: var(--card); border-radius: 28px; box-shadow: 0 10px 30px rgba(0,0,0,.08);
            overflow: hidden; border: 1px solid #F1F5F9;
        }
        header {
            display:flex; align-items:center; justify-content:space-between;
            padding:14px 18px; border-bottom:1px solid var(--line); font-weight:600;
        }
        .title-sub {color:#5B7FFF;font-size:12px;font-weight:600;margin-bottom:6px}
        .title-main {font-size:20px;font-weight:800;line-height:1.2;margin:0 0 8px}
        .img-wrap {
            background:#F3F4F6;border-radius:22px;padding:14px;
            display:flex; justify-content:center; align-items:center;
            height:210px; border:1px solid #EEF2F7;
        }
        .img-wrap img {max-height:100%; max-width:100%; border-radius:14px; object-fit:contain;}
        .rows {margin-top:14px;border-top:1px solid var(--line)}
        .row {display:flex; gap:14px; padding:12px 2px; border-bottom:1px solid var(--line); font-size:14px}
        .row b {color:#2563EB; min-width:80px}
        .row .val {white-space:pre-wrap; color:#111827}
        .hint {color:var(--muted); font-size:12px}
        .actions {display:flex; gap:10px; padding:16px}
        .btn {
            flex:1; padding:13px 14px; border-radius:14px; border:1px solid var(--line);
            background:#F3F4F6; color:var(--muted); font-weight:700;
        }
        .btn.primary {background:var(--primary); color:#fff; border-color:var(--primary)}
        .uploader {padding:14px 16px; display:flex; gap:10px; align-items:center}
        .filebox input[type="file"]{display:none}
        .filebox label{padding:10px 12px;border:1px dashed var(--line);
            border-radius:12px;background:#fff;cursor:pointer;font-size:13px}
        .status {padding:0 16px 12px; font-size:13px; color:var(--muted)}
        .badge {background:var(--chip); color:#4155D1; padding:3px 8px;
            border-radius:999px; font-size:11px; font-weight:700; display:inline-block}
    </style>
</head>
<body>
<div class="phone">
    <div class="card" id="app">
        <header>
            <button id="back" aria-label="back"
                    style="background:none;border:0;font-size:18px;color:#6B7280">â€¹</button>
            <div>ë¶„ì„ ê²°ê³¼</div>
            <div style="width:18px"></div>
        </header>

        <!-- ì—…ë¡œë“œ ì˜ì—­ -->
        <div class="uploader">
            <div class="filebox">
                <input type="file" id="file" accept="image/*" />
                <label for="file">ì‚¬ì§„ ì„ íƒ</label>
            </div>
            <button class="btn primary" id="analyzeBtn">ë¶„ì„í•˜ê¸°</button>
            <span class="badge" id="fakeBtn" title="ì„œë²„ ì—†ì´ ë°ëª¨">ë°ëª¨</span>
        </div>
        <div class="status" id="status">ì˜· ì‚¬ì§„ì„ ì„ íƒí•˜ê³  â€œë¶„ì„í•˜ê¸°â€ë¥¼ ëˆŒëŸ¬ì£¼ì„¸ìš”.</div>

        <!-- ê²°ê³¼ í™”ë©´ -->
        <div style="padding:0 16px 16px">
            <div class="title-sub">ì˜ë¥˜ / ë‹ˆíŠ¸</div>
            <div class="title-main" id="title">í´ë¡œ ì½”íŠ¼ ì¼€ì´ë¸” ë‹ˆíŠ¸</div>

            <div class="img-wrap"><img id="preview" alt="preview" /></div>

            <div class="rows" id="rows">
                <div class="row"><b>ì†Œì¬</b><div class="val" id="mat">-</div></div>
                <div class="row"><b>ìƒ‰ìƒ</b><div class="val" id="col">-</div></div>
                <div class="row"><b>ì„¸íƒ ë°©ë²•</b><div class="val" id="wash">-</div></div>
                <div class="row"><b>ì£¼ì˜ì‚¬í•­</b><div class="val" id="caution">-</div></div>
            </div>
        </div>

        <div class="actions">
            <button class="btn" id="resetBtn">ë‹¤ì‹œ ê²€ìƒ‰í•˜ê¸°</button>
            <button class="btn primary" id="saveBtn">ê²°ê³¼ ì €ì¥í•˜ê¸°</button>
        </div>
    </div>
</div>

<script>

    /* ----------------------------------------------------
       ğŸ”¥ JWT ìë™ í¬í•¨ fetch í•¨ìˆ˜
    ---------------------------------------------------- */
    function authFetch(url, options = {}) {
        const token = localStorage.getItem("posong_jwt");

        if (!token) {
            alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
            window.location.href = "/login.html";
            return Promise.reject("NO_TOKEN");
        }

        options.headers = {
            ...(options.headers || {}),
            "Authorization": `Bearer ${token}`
        };

        return fetch(url, options);
    }

    /* ----------------------------------------------------
       DOM ìš”ì†Œ
    ---------------------------------------------------- */
    const $ = (sel)=>document.querySelector(sel);
    const fileEl = $('#file');
    const previewEl = $('#preview');
    const statusEl = $('#status');
    const analyzeBtn = $('#analyzeBtn');
    const resetBtn = $('#resetBtn');
    const saveBtn = $('#saveBtn');
    const fakeBtn = $('#fakeBtn');

    let currentResult = null;

    /* ----------------------------------------------------
       ë¯¸ë¦¬ë³´ê¸°
    ---------------------------------------------------- */
    fileEl.addEventListener('change', () => {
        const f = fileEl.files?.[0];
        if (!f) return;
        const url = URL.createObjectURL(f);
        previewEl.src = url;
        statusEl.textContent = `ì„ íƒë¨: ${f.name} (${Math.round(f.size/1024)}KB)`;
        currentResult = null;
        setFields();
    });

    /* ----------------------------------------------------
       ğŸ”¥ ì„œë²„ ë¶„ì„ ìš”ì²­ (JWT í¬í•¨)
    ---------------------------------------------------- */
    analyzeBtn.addEventListener('click', async () => {
        const f = fileEl.files?.[0];
        if (!f) { alert('ì‚¬ì§„ì„ ì„ íƒí•´ì£¼ì„¸ìš”.'); return; }

        statusEl.textContent = 'ë¶„ì„ ì¤‘â€¦ ì ì‹œë§Œìš”.';
        analyzeBtn.disabled = true;

        try {
            const fd = new FormData();
            fd.append('file', f);

            const res = await authFetch('/api/analyze/image', {
                method:'POST',
                body: fd
            });

            if (!res.ok) throw new Error(`HTTP ${res.status}`);

            currentResult = await res.json();
            setFields(currentResult);
            statusEl.textContent = 'ë¶„ì„ ì™„ë£Œ!';

        } catch (e) {
            console.error(e);
            statusEl.textContent = 'ë¶„ì„ ì‹¤íŒ¨â€¦ ì„œë²„ê°€ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸í•˜ì„¸ìš”.';
        } finally {
            analyzeBtn.disabled = false;
        }
    });

    /* ----------------------------------------------------
       ë°ëª¨ ë°ì´í„°
    ---------------------------------------------------- */
    fakeBtn.addEventListener('click', () => {
        if (!previewEl.src) previewEl.src = 'https://picsum.photos/seed/knit/500/400';
        currentResult = {
            "ì†Œì¬": "í”¼ë§ˆì½”íŠ¼",
            "ìƒ‰ìƒ": "ì°¨ì½œ ê·¸ë ˆì´",
            "ì„¸íƒë°©ë²•": "ë“œë¼ì´í´ë¦¬ë‹ ê¶Œì¥ Â· 30Â°C ì´í•˜ ì¤‘ì„±ì„¸ì œ",
            "ì£¼ì˜ì‚¬í•­": "ì„¸íƒë§ ì‚¬ìš©, í‰í‰í•˜ê²Œ ê·¸ëŠ˜ ê±´ì¡°",
        };
        setFields(currentResult);
        statusEl.textContent = 'ë°ëª¨ ë°ì´í„° ë¡œë“œ ì™„ë£Œ!';
    });

    /* ----------------------------------------------------
       ë‹¤ì‹œ ê²€ìƒ‰
    ---------------------------------------------------- */
    resetBtn.addEventListener('click', () => {
        fileEl.value = '';
        previewEl.removeAttribute('src');
        currentResult = null;
        setFields();
        statusEl.textContent = 'ì˜· ì‚¬ì§„ì„ ì„ íƒí•˜ê³  â€œë¶„ì„í•˜ê¸°â€ë¥¼ ëˆŒëŸ¬ì£¼ì„¸ìš”.';
    });

    /* ----------------------------------------------------
       ê²°ê³¼ ì €ì¥ (ë¡œì»¬ ì €ì¥)
    ---------------------------------------------------- */
    saveBtn.addEventListener('click', () => {
        if (!currentResult) { alert('ë¶„ì„ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.'); return; }

        const blob = new Blob([JSON.stringify(currentResult, null, 2)], {type:'application/json'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `posongi-result-${Date.now()}.json`;
        a.click();
        URL.revokeObjectURL(a.href);
    });

    /* ----------------------------------------------------
       í•„ë“œ ì±„ìš°ê¸°
    ---------------------------------------------------- */
    function setFields(res){
        $('#mat').textContent = res?.['ì†Œì¬'] ?? '-';
        $('#col').textContent = res?.['ìƒ‰ìƒ'] ?? '-';
        $('#wash').textContent = res?.['ì„¸íƒë°©ë²•'] ?? '-';
        $('#caution').textContent = res?.['ì£¼ì˜ì‚¬í•­'] ?? '-';
    }
</script>
</body>
</html>
