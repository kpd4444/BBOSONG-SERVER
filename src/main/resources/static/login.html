<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ë½€ì†¡ì´ ë¡œê·¸ì¸</title>
    <style>
        /* ë””ìì¸ì€ ê¸°ì¡´ê³¼ ë™ì¼í•˜ê²Œ ê¹”ë”í•œ ìŠ¤íƒ€ì¼ ìœ ì§€ */
        body {
            font-family: "Apple SD Gothic Neo", "Malgun Gothic", sans-serif;
            background: #f5f5ff;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
        }

        .container {
            background: white;
            padding: 32px;
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            width: 360px;
        }

        h2 {
            text-align: center;
            color: #333;
            margin-top: 0;
            margin-bottom: 24px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
            font-weight: 600;
            color: #555;
        }

        input {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #ddd;
            box-sizing: border-box;
            margin-bottom: 16px;
            font-size: 14px;
            transition: border-color 0.2s;
        }

        input:focus {
            border-color: #4b6bff;
            outline: none;
        }

        button {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            border: none;
            background: #4b6bff;
            color: white;
            font-weight: 700;
            cursor: pointer;
            font-size: 16px;
            transition: background 0.2s;
        }

        button:hover {
            background: #3a57e8;
        }

        button:disabled {
            background: #b4c0ff;
            cursor: not-allowed;
        }

        .msg {
            margin-top: 16px;
            font-size: 14px;
            text-align: center;
            min-height: 20px;
        }

        .msg.error { color: #e53935; }
        .msg.success { color: #1e8e3e; }

        /* ë””ë²„ê¹…ìš© í† í° ë°•ìŠ¤ (í•„ìš” ì—†ìœ¼ë©´ style="display:none" ì²˜ë¦¬ ê°€ëŠ¥) */
        .debug-box {
            margin-top: 24px;
            padding-top: 16px;
            border-top: 1px solid #eee;
            font-size: 12px;
            color: #888;
        }
        .debug-box textarea {
            width: 100%;
            height: 60px;
            font-size: 11px;
            margin-top: 5px;
            color: #aaa;
            border: 1px solid #eee;
            resize: none;
        }
    </style>
</head>
<body>

<div class="container">
    <h2>ğŸ§¼ ë½€ì†¡ì´ ë¡œê·¸ì¸</h2>

    <form id="loginForm">
        <label for="loginId">ì•„ì´ë””</label>
        <input type="text" id="loginId" name="loginId" placeholder="ì•„ì´ë””ë¥¼ ì…ë ¥í•˜ì„¸ìš”" required>

        <label for="password">ë¹„ë°€ë²ˆí˜¸</label>
        <input type="password" id="password" name="password" placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”" required>

        <button type="submit" id="loginBtn">ë¡œê·¸ì¸ í•˜ê¸°</button>
    </form>

    <div id="message" class="msg"></div>

    <div class="debug-box">
        <div>ë°œê¸‰ëœ í† í° (ìë™ ì €ì¥ë¨):</div>
        <textarea id="tokenArea" readonly></textarea>
    </div>
</div>

<script>
    const form = document.getElementById("loginForm");
    const loginBtn = document.getElementById("loginBtn");
    const messageDiv = document.getElementById("message");
    const tokenArea = document.getElementById("tokenArea");

    form.addEventListener("submit", function (e) {
        e.preventDefault(); // í¼ì˜ ê¸°ë³¸ ìƒˆë¡œê³ ì¹¨ ë°©ì§€

        const loginId = document.getElementById("loginId").value.trim();
        const password = document.getElementById("password").value.trim();

        if (!loginId || !password) {
            showMessage("ì•„ì´ë””ì™€ ë¹„ë°€ë²ˆí˜¸ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.", true);
            return;
        }

        // ë¡œë”© ìƒíƒœ ì‹œì‘
        loginBtn.disabled = true;
        loginBtn.textContent = "ë¡œê·¸ì¸ ì¤‘...";
        showMessage("");

        fetch("/member/login", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                loginId: loginId,
                password: password
            })
        })
            .then(async (res) => {
                const text = await res.text(); // ì‘ë‹µì„ í…ìŠ¤íŠ¸ë¡œ ë¨¼ì € ë°›ìŒ

                if (!res.ok) {
                    throw new Error(text || "ë¡œê·¸ì¸ ì‹¤íŒ¨");
                }

                // 1. í† í° ì¶”ì¶œ (JSON í˜•ì‹ì´ë“  ë‹¨ìˆœ ë¬¸ìì—´ì´ë“  ì²˜ë¦¬)
                let token;
                try {
                    const json = JSON.parse(text);
                    token = json.token || text; // {"token": "..."} í˜•íƒœë¼ë©´ .token ì‚¬ìš©
                } catch (e) {
                    token = text; // ê·¸ëƒ¥ ë¬¸ìì—´ì´ë©´ ê·¸ëŒ€ë¡œ ì‚¬ìš©
                }

                if (!token) {
                    throw new Error("ì„œë²„ì—ì„œ í† í°ì„ ë°›ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
                }

                // 2. í™”ë©´ì— í† í° í‘œì‹œ (ë””ë²„ê¹…ìš©)
                tokenArea.value = token;

                // 3. ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— í† í° ì €ì¥ (í•µì‹¬!)
                localStorage.setItem("token", token);

                // 4. ì„±ê³µ ë©”ì‹œì§€ ë° í˜ì´ì§€ ì´ë™
                showMessage("ë¡œê·¸ì¸ ì„±ê³µ! ì±„íŒ…ë°©ìœ¼ë¡œ ì´ë™í•©ë‹ˆë‹¤...", false, true);

                setTimeout(() => {
                    // ì±„íŒ… í˜ì´ì§€ë¡œ ì´ë™
                    window.location.href = "/chat.html";
                }, 1000); // ì‚¬ìš©ìê°€ ì„±ê³µ ë©”ì‹œì§€ë¥¼ ë³¼ ìˆ˜ ìˆê²Œ 1ì´ˆ ë’¤ ì´ë™
            })
            .catch((err) => {
                console.error(err);
                showMessage("ë¡œê·¸ì¸ ì‹¤íŒ¨: " + checkErrorMsg(err.message), true);
                tokenArea.value = "";

                // ë²„íŠ¼ ìƒíƒœ ë³µêµ¬
                loginBtn.disabled = false;
                loginBtn.textContent = "ë¡œê·¸ì¸ í•˜ê¸°";
            });
    });

    // ì—ëŸ¬ ë©”ì‹œì§€ ë‹¤ë“¬ê¸° í•¨ìˆ˜
    function checkErrorMsg(msg) {
        if(msg.includes("Bad credentials") || msg.includes("401")) {
            return "ì•„ì´ë”” ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.";
        }
        return msg;
    }

    // ë©”ì‹œì§€ í‘œì‹œ í•¨ìˆ˜
    function showMessage(msg, isError = false, isSuccess = false) {
        messageDiv.textContent = msg;
        messageDiv.className = "msg"; // í´ë˜ìŠ¤ ì´ˆê¸°í™”

        if (isError) {
            messageDiv.classList.add("error");
        } else if (isSuccess) {
            messageDiv.classList.add("success");
        }
    }
</script>

</body>
</html>