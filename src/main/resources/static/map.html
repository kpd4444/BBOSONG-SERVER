<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="utf-8">
    <title>ÎΩÄÏÜ°Ïù¥ ÏÑ∏ÌÉÅÏÜå ÏßÄÎèÑ</title>
    <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=bb0c3fb1577a5c90389922daee14b32c&libraries=services"></script>
    <style>
        html, body {
            margin: 0;
            height: 100%;
            font-family: "Apple SD Gothic Neo", sans-serif;
            background: #eef2ff;
        }
        #map {
            width: 100%;
            height: 100vh;
        }
        #card {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #fff;
            border-top-left-radius: 20px;
            border-top-right-radius: 20px;
            box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.1);
            padding: 20px;
            line-height: 1.6;
            animation: slideUp .3s ease;
            z-index: 10;
        }
        @keyframes slideUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }
        #card h3 { margin: 0; font-size: 18px; }
        #card p { margin: 6px 0; color: #555; }
        #card a { color: #2563eb; text-decoration: none; }
        #searchBox {
            position: fixed;
            top: 15px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 8px;
            background: #fff;
            border-radius: 16px;
            padding: 8px 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            z-index: 5;
        }
        #keyword {
            border: none;
            outline: none;
            font-size: 15px;
            width: 180px;
        }
        button {
            background: #3B82F6;
            color: #fff;
            border: none;
            border-radius: 10px;
            padding: 8px 12px;
            font-weight: 700;
            cursor: pointer;
        }
    </style>
</head>
<body>

<div id="searchBox">
    <input id="keyword" type="text" placeholder="ÏÑ∏ÌÉÅÏÜå Í≤ÄÏÉâ..." />
    <button id="searchBtn">Í≤ÄÏÉâ</button>
</div>

<div id="map"></div>

<div id="card">
    <h3 id="placeName"></h3>
    <p id="address"></p>
    <p id="phone"></p>
    <p><a id="link" href="#" target="_blank">Ïπ¥Ïπ¥Ïò§ÎßµÏóêÏÑú Î≥¥Í∏∞</a></p>
</div>

<script>
    const mapContainer = document.getElementById('map');
    const map = new kakao.maps.Map(mapContainer, {
        center: new kakao.maps.LatLng(37.5665, 126.9780),
        level: 4
    });

    let markers = [];

    function showCard(place) {
        document.getElementById('placeName').textContent = place.place_name;
        document.getElementById('address').textContent = place.road_address_name || place.address_name;
        document.getElementById('phone').textContent = place.phone ? `üìû ${place.phone}` : "Ï†ÑÌôîÎ≤àÌò∏ ÏóÜÏùå";
        document.getElementById('link').href = place.place_url;
        document.getElementById('card').style.display = 'block';
    }

    function clearMarkers() {
        markers.forEach(m => m.setMap(null));
        markers = [];
    }

    function searchNearby(keyword, lat, lon) {
        fetch(`http://localhost:8080/api/places/search?query=${encodeURIComponent(keyword)}&x=${lon}&y=${lat}&radius=1500`)
            .then(res => res.text())           // ‚úÖ ÏÑúÎ≤ÑÍ∞Ä JSON Î¨∏ÏûêÏó¥ÏùÑ Î∞òÌôòÌïòÎØÄÎ°ú textÎ°ú ÏùΩÍ∏∞
            .then(text => {
                const data = JSON.parse(text);   // ‚úÖ ÏßÅÏ†ë ÌååÏã±
                clearMarkers();
                data.documents.forEach(place => {
                    const marker = new kakao.maps.Marker({
                        map: map,
                        position: new kakao.maps.LatLng(place.y, place.x)
                    });
                    markers.push(marker);
                    kakao.maps.event.addListener(marker, 'click', () => {
                        console.log("ÌÅ¥Î¶≠Îê®:", place.place_name);
                        showCard(place);
                    });
                });
                if (data.documents.length > 0) {
                    map.setCenter(new kakao.maps.LatLng(data.documents[0].y, data.documents[0].x));
                }
            })
            .catch(err => {
                console.error("‚ùå ÏÑúÎ≤Ñ Ïó∞Í≤∞ Ïã§Ìå®:", err);
                alert("ÏÑúÎ≤Ñ ÎòêÎäî CORS ÏÑ§Ï†ïÏùÑ ÌôïÏù∏Ìï¥Ï£ºÏÑ∏Ïöî.");
            });
    }

    function loadMyLocation() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(pos => {
                const lat = pos.coords.latitude;
                const lon = pos.coords.longitude;
                map.setCenter(new kakao.maps.LatLng(lat, lon));
                searchNearby("ÏÑ∏ÌÉÅÏÜå", lat, lon);
            }, () => {
                alert("ÏúÑÏπò Ï†ëÍ∑ºÏù¥ Ï∞®Îã®ÎêòÏóàÏäµÎãàÎã§. Í∏∞Î≥∏ ÏúÑÏπò(ÏÑúÏö∏ ÏãúÏ≤≠)Î°ú ÌëúÏãúÌï©ÎãàÎã§.");
                searchNearby("ÏÑ∏ÌÉÅÏÜå", 37.5665, 126.9780);
            });
        } else {
            alert("Ïù¥ Î∏åÎùºÏö∞Ï†ÄÏóêÏÑúÎäî ÏúÑÏπò Ï†ïÎ≥¥Î•º ÏÇ¨Ïö©Ìï† Ïàò ÏóÜÏäµÎãàÎã§.");
        }
    }

    document.getElementById('searchBtn').addEventListener('click', () => {
        const keyword = document.getElementById('keyword').value.trim() || "ÏÑ∏ÌÉÅÏÜå";
        navigator.geolocation.getCurrentPosition(pos => {
            searchNearby(keyword, pos.coords.latitude, pos.coords.longitude);
        });
    });
    // Ï¥àÍ∏∞ ÏßÄÎèÑ Î°úÎî©
    loadMyLocation();
</script>
</body>
</html>